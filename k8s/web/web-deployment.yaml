apiVersion: apps/v1
kind: Deployment
metadata:
 name: web-deployment
spec:
 replicas: 1
 selector:
   matchLabels:
     app: web
 template:
   metadata:
     labels:
       app: web
   spec:
     containers:
       - name: web
         image: jondaw/devops-web:develop
         ports:
           - containerPort: 4000
         resources:
           requests:
             memory: "64Mi"
             cpu: "50m"
           limits:
             memory: "128Mi"
             cpu: "100m"
         # Убираем readinessProbe, так как в приложении нет отдельного endpoint'а для проверки здоровья
         # readinessProbe:
         #   httpGet:
         #     path: /
         #     port: 4000
         #   initialDelaySeconds: 5
         #   periodSeconds: 10
         #   timeoutSeconds: 2
         #   successThreshold: 1
         #   failureThreshold: 3
         env:
           - name: API_HOST
             valueFrom:
               configMapKeyRef:
                 name: web-config
                 key: API_HOST
         securityContext:
           allowPrivilegeEscalation: false
           runAsNonRoot: true
           runAsUser: 1000
           capabilities:
             drop:
               - ALL
     terminationGracePeriodSeconds: 30
     affinity:
       podAntiAffinity:
         preferredDuringSchedulingIgnoredDuringExecution:
           - weight: 100
             podAffinityTerm:
               labelSelector:
                 matchExpressions:
                   - key: app
                     operator: In
                     values:
                       - web
               topologyKey: "kubernetes.io/hostname"